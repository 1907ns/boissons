<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tests recherche</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
        let usedSearch = false;
        // Fonction permettant de lister les propositions sous la barre de recherche
        function liste(){
            document.getElementById("liste").innerHTML = "";
            //On récupère la valeur qu'on essaiera de faire "matcher" pour retrouver différentes propositions
            match = document.getElementById('search').value;
            //On ne fait rien tant que la barre de recherche est vide
            if(match != "") {
                //On appelle la fonction traitementRecettes, qui va réaliser l'appel Ajax pour obtenir les valeurs ressemblant au match passé en paramètre
                //Cette fonction va ensuite, dans l'appel Ajax, appeler la fonction passée en paramètre avec le résultat, ce qui permet un traitement synchrone de l'information
                //Un traitement synchrone permet d'attendre que la totalité des informations soient récupérées avant de les utiliser
                traitementRecettes(match, function (recs){
                    if (recs.titre[0] != "none") {
                        for (let i = 0; i < recs.titre.length; i++) {
                            document.getElementById("liste").innerHTML += '<option value="' + recs.titre[i] + '">Recette : ' + recs.titre[i] + '</option>';
                        }
                    }
                });
                //Autour de l'appel à la fonction traitementRecettes, le traitement est asynchrone, ce qui veut dire que la suite du code s'exécute en parallèle de l'appel à traitementRecettes
                //On appelle la fonction traitementIngredients, qui traite l'information de façon synchrone, comme traitementRecettes
                traitementIngredients(match, function (ings) {
                    if (ings.nom[0] != "none") {
                        for (let i = 0; i < ings.nom.length; i++) {
                            document.getElementById("liste").innerHTML += '<option value="' + ings.nom[i] + '"/>Ingrédient : ' + ings.nom[i] + '</option>';
                        }
                    }
                });
            }
        }

        //La fonction traitementRecettes permet de récupérer les données des recettes par comparaison avec Ajax et de les traiter de façon synchrone
        function traitementRecettes(match, traitement){
            $.ajax({
                type: 'POST',
                url: 'TraitementRecettes.php',
                data: {func: 'matchNom', var: match},
                dataType: 'JSON',
                success: function (ret) {
                    let recs = JSON.parse(ret);
                    traitement(recs);
                }
            });
        }

        //La fonction traitementRecettesContient permet de récupérer les données des recettes qui contiennent un certain ingrédient avec Ajax et de les traiter de façon synchrone
        function traitementRecetteContient(ing, traitement){
            $.ajax({
                type: 'POST',
                url: 'TraitementRecettes.php',
                data: {func: 'recIng', var: ing},
                dataType: 'JSON',
                success: function (ret) {
                    let recs = JSON.parse(ret);
                    traitement(recs);
                }
            });
        }

        //La fonction traitementIngredients permet de récupérer les données des ingrédients par comparaison avec Ajax et de les traiter de façon synchrone
        function traitementIngredients(match, traitement){
            $.ajax({
                type: 'POST',
                url: 'TraitementHierarchie.php',
                data: {func: 'matchNom', var: match},
                dataType: 'JSON',
                success: function (ret) {
                    let ings = JSON.parse(ret);
                    traitement(ings);
                }
            })
        }

        //La fonction traitementSousCateg permet de récupérer les données des sous ingrédients d'ingrédient donné avec Ajax et de les traiter de façon synchrone
        function traitementSousCateg(nomSource, traitement){
            $.ajax({
                type:'POST',
                url:'TraitementHierarchie.php',
                data:{func: 'sub', var:nomSource},
                dataType: 'JSON',
                success: function (ret){
                    let subs = JSON.parse(ret);
                    traitement(subs);
                }
            })
        }

        //La fonction affciherResultats permet d'afficher les résultats de la recherche
        function afficherResultats(){
            usedSearch = true;
            let allIngs = Array();
            let recAff = Array();
            let dernierIng = false;
            //On récupère la valeur qu'on essaiera de faire "matcher" pour retrouver différents résultats
            let match = document.getElementById('search').value;
            document.getElementById("ResSearch").innerHTML = '<h1>Liste des résultats pour "' + match +'"</h1><ul id="listeResults" style="overflow: auto; width: 750px">';
            if(match != "") {
                //On appelle la fonction traitementIngredients pour récupérer les différents ingrédients correspondant au match et les traiter de façon asynchrone
                traitementIngredients(match, function (ings) {
                    //On ne fait rien si aucun argument ne correspond à la recherche
                    if (ings.nom[0] != "none") {
                        for (let i = 0; i < ings.nom.length; i++) {
                            document.getElementById("listeResults").innerHTML += '<li style="overflow: visible"/><a href="Ingredient.php?nom=' + ings.nom[i] + '"> Ingrédient : ' + ings.nom[i] + '</a></li>';
                            if (!allIngs.includes(ings.nom[i])) {
                                allIngs.push(ings.nom[i]);
                            }
                            //On prévient qu'on se trouve sur le dernier ingrédient
                            if(i == ings.nom.length-1){
                                dernierIng=true;
                            }
                            //On appelle la fonction traitementSousCateg pour récupérer les sous ingrédients de chaque ingrédient récupéré par la recherche et les traiter de façon synchrone
                            traitementSousCateg(ings.nom[i], function (subs) {
                                if (subs.nom[0] != "none") {
                                    for (let i = 0; i < subs.nom.length; i++) {
                                        document.getElementById("listeResults").innerHTML += '<li style="overflow: visible"/><a href="Ingredient.php?nom=' + subs.nom[i] + '"> Sous-ingrédient : ' + subs.nom[i] + '</a></li>';
                                        if (!allIngs.includes(subs.nom[i])) {
                                            allIngs.push(subs.nom[i]);
                                        }
                                    }
                                }
                                //Si on est sur le dernier ingrédient (et qu'on a donc récupéré les derniers sous ingrédients), on lance l'affichage des recettes contenant tous ces ingrédients
                                if(dernierIng){
                                    afficherRecettesContenant(allIngs, recAff);
                                }
                            });
                        }
                    }
                });
                //On appelle traitementRecettes pour récupérer les données des recettes correspondant au match et les traiter de façon asynchrone
                traitementRecettes(match, function (recs){
                    if (recs.titre[0] != "none") {
                        for (let i = 0; i < recs.titre.length; i++) {
                            //On on ajoute cette recette dans les recettes affichées à l'écran
                            recAff.push(recs.titre[i]);
                            document.getElementById("listeResults").innerHTML += '<li style="overflow: visible"><a href="Recette.php?nom=' + recs.titre[i] + '">Recette : ' + recs.titre[i] + '</a></li>';
                        }
                    }
                });
            }
            document.getElementById("ResSearch").innerHTML += "</ul>";
        }

        //la fontion afficherRecettesContenant permet d'afficher les recettes contenant une liste d'ingrédients donnée
        function afficherRecettesContenant(allIngs, recAff){
            for (let i = 0; i < allIngs.length; i++) {
                //On appelle traitementRecetteContient pour récupérer les recettes contenant un ingrédient donné et traiter les données de façon synchrone
                traitementRecetteContient(allIngs[i], function (recs) {
                    if (recs.titre[0] != "none") {
                        for (let j = 0; j < recs.titre.length; j++) {
                            if (!recAff.includes(recs.titre[j])) {
                                //On ajoute la recette dans les recettes affichées à l'écran
                                recAff.push(recs.titre[j]);
                                document.getElementById("listeResults").innerHTML += '<li style="overflow: visible"><a href="Recette.php?nom=' + recs.titre[j] + '">Recette contenant "' + allIngs[i] + '" : ' + recs.titre[j] + '</a></li>';
                            }
                        }
                    }
                });
            }
        }

        //Quand toutes les requêtes ajax sont terminées
        $(document).ajaxStop(function (){
            //Si une recherche a été efféctuée
            if(usedSearch) {
                //Si le résultat de la recherche est vide on affiche un message indiquant que rien n'a été trouvé
                if (document.getElementById("listeResults").childElementCount == 0) {
                    document.getElementById("listeResults").style.visibility = "hidden";
                    document.getElementById("ResSearch").innerHTML = '<h1>Liste des résultats pour "' + match + '"</h1><h2>Aucun résultat trouvé pour cette recherche.</h2>';
                }
            }
        })
    </script>
</head>
<body>
    <div>
        <input style="width: 500px;" list="liste" type="text" name="rechercheBoissons" placeholder="Rechercher.." id="search" oninput="liste()">
        <button onclick="afficherResultats()"><img style="max-height: 15px" src="../images/search.webp"></button>
        <datalist id="liste"></datalist>
    </div>
    <div id="ResSearch"></div>
</body>
